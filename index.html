<!DOCTYPE html>

<html>
	<body>
		<canvas id="canvas" width="640" height="360"></canvas>
	</body>
</html>

<script>
	/*
	Facing | North: 0, East: 1, South: 2, West: 3
	*/

	// References
	const canvas = document.getElementById("canvas");
	const ctx = canvas.getContext("2d");
	ctx.imageSmoothingEnabled = false; // Since a bit pixelated, this looks better

	// Events
	function getCursorPosition(canvas, event) {
		const rect = canvas.getBoundingClientRect();
		mousePosition.x = event.clientX - rect.left;
		mousePosition.y = event.clientY - rect.top;
	}

	canvas.addEventListener('mousedown', function(e) {
		getCursorPosition(canvas, e);
		leftClick = true;
	});

	// Sounds
	const safeBeep = new Sound("sounds/safeBeep.mp3");
	const safeSuccess = new Sound("sounds/safeSuccess.mp3");
	const safeFail = new Sound("sounds/safeFail.mp3");
	const keyTurned = new Sound("sounds/keyTurned.wav");
	const writing = new Sound("sounds/writing.wav");
	const paperSlide = new Sound("sounds/paperSlide.wav");
	const latch = new Sound("sounds/latch.wav");
	const doorknobTurn = new Sound("sounds/doorknob.mp3")

	// Temporary storage
	const room = {facing:0, zoom: "", look: function(left){
			if(room.zoom !== ""){
				room.zoom = "";
				return;
			}

			if(left) this.facing--;
			else this.facing++;

			this.facing = mod(this.facing, 4);
		},
		pause: function(){
			room.zoom = "pause";
		}};
	let player = {inventory:[undefined, undefined, undefined, undefined, undefined, undefined], selected:""};
	let mousePosition = {x:0, y:0};
	let leftClick = true;
	let components = [];
	let slotApx = 0;
	let code = "";
	let clickHeat = 2;
	let doorUnlocked = false;

	const backgrounds = ["clock", "desk", "door", "door-bottom", "dresser",
	"man", "open-dresser", "openedDoor", "openedSafe", "safe", "start0",
	"start1", "start2", "start3", "window-day", "window-night"];

	// Objects
	new Component(640, 360, "images/backgrounds/start0", 0, 0, 1, {updated: backgroundCheck});
	new Component(40, 40, "images/ui/arrows/left", 40, 160, 4, {clicked: function(){room.look(true)}});
	new Component(40, 40, "images/ui/arrows/right", 560, 160, 4, {clicked: function(){room.look(false)}});
	new RoomComponent(54, 10, "images/objects/empty", 471, 309, 1, "window-day", 0, {clicked: windowInteract})
	new RoomComponent(54, 10, "images/objects/empty", 471, 309, 1, "window-night", 0, {clicked: windowInteract})

	slotApx = components.length;

	// Draw inventory slots
	for(let k = 0; k < 6; k++){
		new Component(50, 50, "images/ui/slot", 90 + 80 * k, 300, 1, {});
	}

	const smallWindow = new RoomComponent(100, 75, "images/objects/window", 270, 120, 1, "", 0, {clicked: handleWindow, updated: lightOrDarkWindow}); // Window
	new RoomComponent(354, 300, "images/objects/empty", 221, 42, 1, "open-dresser", 0, {}); // Open dresser
	new RoomComponent(213, 300, "images/objects/empty", 221, 42, 1, "dresser", 0, {zoomOn: "open-dresser"}); // Closeup dresser
	new RoomComponent(100, 100, "images/objects/empty", 200, 200, 1, "", 0, {zoomOn: "dresser"}); // Dresser
	new RoomComponent(50, 50, "images/objects/empty", 295, 60, 1, "", 2, {zoomOn: "clock"}); // Clock
	const smallClockHandle = new RoomComponent(17, 17, "images/objects/clockHands/smallHand", 314, 79, 1, "", 2, {})
	new RoomComponent(100, 117, "images/objects/empty", 268, 96, 1, "", 3, {zoomOn: "door"}); // Door
	new RoomComponent(100, 83, "images/objects/empty", 268, 213, 1, "", 3, {zoomOn: "door-bottom"}); // Door bottom
	new ItemComponent(55, 33, "images/objects/book", 294, 264, 1, "open-dresser", 0, {}); // Book
	new RoomComponent(50, 50, "images/objects/empty", 150, 250, 1, "", 1, {zoomOn: "goatSkull"}); // Goat skull
	new RoomComponent(100, 100, "images/objects/empty", 260, 210, 1, "", 2, {zoomOn: "safe"}); // Safe
	new RoomComponent(150, 100, "images/objects/empty", 250, 200, 1, "", 1, {zoomOn: "desk"}); // Desk
	new ItemComponent(132, 215, "images/objects/paper", 125, 107, 1, "desk", 1, {}); // Paper
	new ItemComponent(57, 57, "images/objects/pen", 400, 140, 1, "desk", 1, {}); // Pen
	new RoomComponent(306, 11, "images/objects/empty", 177, 290, 1, "door-bottom", 3, {parameterClicked: eyesInteract}); // Eyes at bottom of door
	new RoomComponent(214, 73, "images/objects/empty", 121, 200, 1, "safe", 2, {clicked: pulledLever}); // Safe lever
	new ItemComponent(25, 20, "images/objects/doorKey", 234, 292, 1, "openedSafe", 2, {}); // Door key
	new RoomComponent(16, 21, "images/objects/empty", 126, 242, 1, "door", 3, {clicked: unlockDoor}); // Keyhole
	new RoomComponent(32, 31, "images/objects/empty", 119, 208, 1, "door", 3, {clicked: turnDoorknob}); // Doorknob
	new RoomComponent(373, 360, "images/objects/empty", 122, 0, 1, "openedDoor", 3, {clicked: function() {interval = setInterval(fade, 25, "man");}}); // Man
	new RoomComponent(260, 90, "images/objects/empty", 150, 140, 1, "clock", 2, {clicked: clickedClock}); //Clock body
	const clockHandle = new RoomComponent(37, 37, "images/objects/clockHands/hand", 315, 139, 1, "clock", 2, {init: clockHandInit});
	new RoomComponent(640, 360, "images/objects/man/man", 0, 0, 3, "man", 3, {clicked: function(){interval = setInterval(fade, 25, "");}}); // Man
	const brokenCompass = new RoomComponent(75, 71, "images/objects/brokenCompass", 382, 204, 1, "desk", 1, {clicked: handleBrokenCompass});
	new RoomComponent(33, 34, "images/objects/empty", 443, 123, 1, "", 3, {zoomOn: "symbolGuide"}); // Symbols guide paper
	const lectern = new RoomComponent(60, 120, "images/objects/empty", 137, 194, 1, "", 3, {zoomOn: "lectern"}); // Lectern
	new RoomComponent(200, 116, "images/objects/empty", 133, 155, 1, "lectern", 3, {clicked: function(){flipPage(-1)}}); // Left page
	new RoomComponent(190, 116, "images/objects/empty", 333, 155, 1, "lectern", 3, {clicked: function(){flipPage(1)}}); // Right page
	new RoomComponent(472, 156, "images/objects/empty", 84, 131, 1, "lectern", 3, {clicked: handleLectern}); // Lectern click area

	for(let x = 0; x < 3; x++){
		for(let y = 0; y < 3; y++){
			new RoomComponent(25, 15, "images/objects/buttons/button" + (x + y * 3), 400 + 30 * x, 30 + 20 * y, 1, "safe", 2, {parameterClicked: safeButton});
		}
	}

	// Load backgrounds
	backgrounds.forEach(background => new RoomComponent(640, 360, "images/backgrounds/" + background, 0, 0, 1, "never", "never", 0, {}));

	new RoomComponent(25, 15, "images/objects/buttons/button-1", 430, 90, 1, "safe", 2, {parameterClicked: safeButton});

	new RoomComponent(640, 360, "images/ui/loading", 0, 0, 1, "never", 0, {});

	let interval;

	let time = 12;
	function clickedClock(){
		time = (time % 12) + 1; // Written kind of weird, but just increases time and keeps it 1...12
		clockHandle.component.frames[0].src = "images/objects/clockHands/hand" + (time - 1) + ".png";
		smallClockHandle.component.frames[0].src = "images/objects/clockHands/smallHand" + (time - 1) + ".png";

		if(time === 6) {
			ctx.globalAlpha = .5;
			// add lightswitch down noise
		}
		else if(time === 7) {
			ctx.globalAlpha = 1;
			// add lightswitch up noise
		}
	}

	let pageComponent;
	function handleLectern(){
		if(player.selected === "book"){
			player.selected = "";

			removeFromInventory("book");

			lectern.component.events.clicked = undefined;

			new RoomComponent(395, 116, "images/objects/openBook", 133, 155, 1, "lectern", 3, {}); // Open book
			pageComponent = new RoomComponent(395, 116, "images/objects/bookPages/page", 133, 155, 1, "lectern", 3, {}); // Page
		}
	}

	let page = 0;
	const PAGE_COUNT = 4;
	function flipPage(direction){
		console.log(pageComponent === undefined);
		if(pageComponent !== undefined)
		{
			page = Math.min(Math.max(0, page + direction), PAGE_COUNT);

			pageComponent.component.frames[0].src = "images/objects/bookPages/page" + page + ".png";
		} else{
			handleLectern();
		}
	}

	function removeFromInventory(item){
		for(let k = 0; k < player.inventory.length; k++){
			if(player.inventory[k] !== undefined && player.inventory[k].name === item){
				components[player.inventory[k].id] = undefined;
				player.inventory[k] = undefined;
				break;
			}
		}
	}

	function clockHandInit(self){
		self.frames[0].src = "images/objects/clockHands/hand11.png";
		smallClockHandle.component.frames[0].src = "images/objects/clockHands/smallHand11.png";
	}

	function handleBrokenCompass(){
		if(player.selected === "compassNeedle"){
			removeFromInventory("compassNeedle");

			components[brokenCompass.numId] = undefined;
			new ItemComponent(75, 71, "images/objects/compass", 382, 204, 1, "desk", 1,
					{clicked: function(){}, invUpdate: handleCompassDirection});
		}
	}

	function handleWindow(){
		if(time !== 6) room.zoom = "window-day";
		else room.zoom = "window-night";
	}

	let compassDirection = [2, 0, 3, 1, 2, 3, 1, 2, 1, 2];
	let compassIndex = 0;
	function handleCompassDirection(self){
		let img = "/images/inventory/compass/";
		const direction = (room.facing - compassDirection[compassIndex] + 4) % 4;

		switch(direction){
			case 0:
				img += "north0.png";
				compassIndex = (compassIndex + 1) % compassDirection.length;
				handleCompassDirection(self); // Stops compass flickering
				break

			case 1:
				img += "east0.png";
				break

			case 2:
				img += "south0.png";
				break

			case 3:
				img += "west0.png";
				break

			default:
				console.log("Compass direction incorrect: " + direction)
		}

		self.frames[0].src = img;
	}

	function lightOrDarkWindow(){
		if(time === 6) smallWindow.component.frames[0].src = "images/objects/dWindow0.png";
		else smallWindow.component.frames[0].src = "images/objects/window0.png";
	}

	function fade(zoom){
		ctx.globalAlpha -= .01;

		if(ctx.globalAlpha <= 0.01){
			clearInterval(interval);
			room.zoom = zoom;
			interval = setInterval(function() {
				ctx.globalAlpha += .01;

				if(ctx.globalAlpha >= 1){
					clearInterval(interval);
				}
			}, 25);
		}
	}

	function turnDoorknob(){
		if(doorUnlocked){
			doorknobTurn.play();
			room.zoom = "openedDoor";
		}
	}

	function unlockDoor(){
		if(player.selected === "doorKey"){
			doorUnlocked = true;
			keyTurned.play();

			removeFromInventory("doorKey");
		}
	}

	function backgroundCheck(component){
		if(room.zoom !== ""){
			component.frames[0].src = "images/backgrounds/" + room.zoom + 0 + ".png";
		} else component.frames[0].src = "images/backgrounds/start" + room.facing + 0 + ".png";
	}

	let spawnedCompassNeedle = false;
	function pulledLever(){
		switch(code){
			case "7805":
				code = "";
				room.zoom = "openedSafe";
				latch.play();
				break

			case "2431":
				code = "";
				room.zoom = "openedSafe";
				latch.play();
				break

			case "5973":
				if(!spawnedCompassNeedle)
				{
					new ItemComponent(25, 20, "images/objects/compassNeedle", 270, 292, 1, "openedSafe", 2, {clicked: function () {}});
					spawnedCompassNeedle = true;
				}
				code = "";
				room.zoom = "openedSafe";
				latch.play();
				break
		}
	}

	function safeButton(component){
		let buttonId = component.src.split("/")[3].split("button")[1];

		safeBeep.play();
		code += parseInt(buttonId) + 1;

		if(code.length >= 4){
			if(code === "7805" || code === "5973" || code === "2431") safeSuccess.play();
			else{
				safeFail.play();
				code = "";
			}
		}
	}

	function eyesInteract(){
		if(player.selected === "writtenPaper"){
			player.selected = "";

			removeFromInventory("writtenPaper");

			new ItemComponent(50, 23, "images/objects/code", 300, 300, 1, "door-bottom", 3, {clicked: function(){}});

			paperSlide.play();
		}
	}

	function windowInteract(){
		let paper = -1;
		let pen = -1;

		for(let k = 0; k < player.inventory.length; k++){
			if(player.inventory[k] !== undefined){
				if(player.inventory[k].name === "paper") paper = k;
				else if(player.inventory[k].name === "pen") pen = k;
			}
		}

		if(pen >= 0 && paper >= 0){
			components[player.inventory[paper].id] = undefined;
			player.inventory[paper] = undefined;

			player.inventory[paper] = new InventoryComponent("images/inventory/writtenPaper", paper, "writtenPaper", {});

			writing.play();
		}
	}


	//
	setInterval(update, 20); // 50 FPS
	setInterval(frameIncrease, 250); // 4 FPS
	let frame = 0;

	function update(){
		ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

		components.forEach(component => { if(component !== undefined) component.update(); });

		if(leftClick) leftClick = false;
	}

	function frameIncrease(){
		frame++;
		clickHeat++;
	}

	function InventoryComponent(image, id, name, events){
		this.id = components.length;
		this.name = name;
		this.slotId = id + slotApx;

		let componentEvents = {};

		componentEvents.clicked = function()
		{
			if (player.selected === name)
			{
				player.selected = "";
				components[id + slotApx].frames[0].src = "images/ui/slot0.png";
			} else
			{
				if (player.selected !== "")
				{
					for (let k = 0; k < player.inventory.length; k++)
					{
						if (player.inventory[k] !== undefined && player.inventory[k].name === player.selected)
						{
							components[player.inventory[k].slotId].frames[0].src = "images/ui/slot0.png";
						}
					}
				}

				player.selected = name;

				components[id + slotApx].frames[0].src = "images/ui/selected0.png";
			}
		}

		if(events.updated !== undefined) componentEvents.updated = events.updated;

		this.component = new Component(50, 50, image, 90 + 80 * id, 300, 1, componentEvents);

		this.update = function(){
			this.component.update();
		}
	}

	function ItemComponent(width, height, image, x, y, frameCount, zoom, facing, events){
		if(events.clicked === undefined) events.clicked = function(){};

		this.component = new RoomComponent(width, height, image, x, y, frameCount, zoom, facing, events);

		components[components.length - 1] = this;
		this.id = components.length - 1;

		this.update = function(){
			this.component.update();

			if(this.component.component.wasClicked){
				components[this.id] = undefined;

				let nextFreeID = -1;
				for(let k = 0; k < player.inventory.length; k++){
					if(player.inventory[k] === undefined) nextFreeID = k;
				}

				let invEvents = {};
				if(events.invUpdate !== undefined) invEvents.updated = events.invUpdate;

				player.inventory[nextFreeID] = new InventoryComponent("images/inventory/" + image.split("/")[2], nextFreeID, image.split("/")[2], invEvents);
			}
		}
	}

	function RoomComponent(width, height, image, x, y, frameCount, zoom, facing, events){
		this.component = new Component(width, height, image, x, y, frameCount, events);

		this.zoom = zoom;
		this.facing = facing;

		this.numId = components.length - 1;
		components[components.length - 1] = this;

		this.update = function(){
			if(room.zoom === this.zoom && room.facing === this.facing) this.component.update();
			else if(frame === 0) this.component.update(); // So image loads
		}
	}

	function Component(width, height, image, x, y, frameCount, events) {
		let frames = [];

		for(let k = 0; k < frameCount; k++){
			frames[k] = new Image();
			frames[k].src = image + k + ".png";
		}

		this.src = image;
		this.frames = frames;

		this.width = width;
		this.height = height;

		this.x = x;
		this.y = y;

		this.events = events;

		this.wasClicked = false;

		components[components.length] = this;

		if(this.events.init !== undefined) this.events.init(this);

		this.update = function() {
			ctx.drawImage(this.frames[mod(frame, frameCount)], this.x, this.y, this.width, this.height);

			this.wasClicked = false;

			if(leftClick && clickHeat > 1 && hasClickEvent(this.events)){
				let mx = mousePosition.x;
				let my = mousePosition.y;

				let ox = this.x;
				let oy = this.y;

				let ow = this.width;
				let oh = this.height;

				if(mx > ox && mx < ox + ow && my > oy && my < oy + oh){
					if(this.events.zoomOn !== undefined) room.zoom = this.events.zoomOn;
					if(this.events.clicked !== undefined) this.events.clicked();
					if(this.events.parameterClicked !== undefined) this.events.parameterClicked(this);

					this.wasClicked = true;
					clickHeat = 0;
				}
			}

			if(this.events.updated !== undefined) this.events.updated(this);
		}
	}

	function hasClickEvent(events){
		if(events.clicked !== undefined) return true;
		if(events.parameterClicked !== undefined) return true;
		if(events.zoomOn !== undefined) return true;
	}

	function Sound(src) {
		this.sound = document.createElement("audio");
		this.sound.src = src;
		this.sound.setAttribute("preload", "auto");
		this.sound.setAttribute("controls", "none");
		this.sound.style.display = "none";
		document.body.appendChild(this.sound);
		this.play = function(){
			this.sound.play();
		}
		this.stop = function(){
			this.sound.pause();
		}
	}

	// Modulus fix
	function mod(n, m) {
		return ((n % m) + m) % m;
	}
</script>

<style>
	body {
		background-color: black;
	}

	#canvas {
		padding: 0;
		margin: auto;
		display: block;
		width: 640px;
		height: 360px;
		position: absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
	}
</style>